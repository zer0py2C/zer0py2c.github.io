<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>FastAPI工程化项目案例 · zer0py2c个人博客</title><meta name="description" content="本案例使用Python语言编写，业务场景为简单的用户操作，整个项目是对FastAPI第三方库的工程化实现。由于博主技术水平有限，如果你在本地测试过程中发现存在BUG，纯属正常，感谢您的理解！！！（本案例使用Python語言編寫，業務場景為簡單的用戶操作，整個項目是對FastAPI第三方庫的工程化實現"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">zer0py2c个人博客</a></h3></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a target="_blank" rel="noopener" href="https://www.caicai.me"> CaiCai </a><span>&</span><a target="_blank" rel="noopener" href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/about">Sobre</a></li><li><a href="/archives">Archivo</a></li><li><a href="/links">Enlaces</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>FastAPI工程化项目案例</a></h3></div><div class="post-content"><p>本案例使用Python语言编写，业务场景为简单的用户操作，整个项目是对FastAPI第三方库的工程化实现。由于博主技术水平有限，如果你在本地测试过程中发现存在BUG，纯属正常，感谢您的理解！！！（本案例使用Python語言編寫，業務場景為簡單的用戶操作，整個項目是對FastAPI第三方庫的工程化實現。由於博主技術水平有限，如果你在本地測試過程中發現存在BUG，純屬正常，感謝您的理解！ ！ ！）</p>
<h5 id="1-项目结构"><a href="#1-项目结构" class="headerlink" title="1.项目结构"></a>1.项目结构</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">|--app</span><br><span class="line">|   |--apiv1</span><br><span class="line">|   |   |--endpoint</span><br><span class="line">|   |   |   |  <span class="strong">__init__</span>.py</span><br><span class="line">|   |   |   |  user.py</span><br><span class="line">|   |   |  <span class="strong">__init__</span>.py</span><br><span class="line">|   |   |  router.py</span><br><span class="line">|   |--common</span><br><span class="line">|   |   |  <span class="strong">__init__</span>.py</span><br><span class="line">|   |   |  constant.py</span><br><span class="line">|   |   |  encrypto.py</span><br><span class="line">|   |   |  utils.py</span><br><span class="line">|   |--core</span><br><span class="line">|   |   |--init</span><br><span class="line">|   |   |   |  <span class="strong">__init__</span>.py</span><br><span class="line">|   |   |   |  cors.py</span><br><span class="line">|   |   |   |  database.py</span><br><span class="line">|   |   |   |  exception.py</span><br><span class="line">|   |   |   |  grequest.py</span><br><span class="line">|   |   |   |  logger.py</span><br><span class="line">|   |   |   |  middleware.py</span><br><span class="line">|   |   |   |  router.py</span><br><span class="line">|   |   |  <span class="strong">__init__</span>.py</span><br><span class="line">|   |   |  codeenum.py</span><br><span class="line">|   |   |  httpresp.py</span><br><span class="line">|   |   |  localproxy.py</span><br><span class="line">|   |   |  serialize.py</span><br><span class="line">|   |--model</span><br><span class="line">|   |   |  <span class="strong">__init__</span>.py</span><br><span class="line">|   |   |  base.py</span><br><span class="line">|   |   |  user.py</span><br><span class="line">|   |--schema</span><br><span class="line">|   |   |  <span class="strong">__init__</span>.py</span><br><span class="line">|   |   |  user.py</span><br><span class="line">|   |--service</span><br><span class="line">|   |   |  <span class="strong">__init__</span>.py</span><br><span class="line">|   |   |  user.py</span><br><span class="line">|   |  <span class="strong">__init__</span>.py</span><br><span class="line">|  .env</span><br><span class="line">|  <span class="strong">__init__</span>.py</span><br><span class="line">|  config.py</span><br><span class="line">|  main.py</span><br></pre></td></tr></table></figure>



<h5 id="2-模块实现"><a href="#2-模块实现" class="headerlink" title="2.模块实现"></a>2.模块实现</h5><h6 id="2-1公共模块"><a href="#2-1公共模块" class="headerlink" title="2.1公共模块"></a>2.1公共模块</h6><ul>
<li>常量集定义</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">DEFAULT_PAGE = <span class="number">1</span></span><br><span class="line">DEFAULT_PER_PAGE = <span class="number">10</span></span><br><span class="line">DEFAULT_FAIL = -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">CACHE_FIVE_SECONDS = <span class="number">5</span></span><br><span class="line">CACHE_MINUTE = <span class="number">60</span></span><br><span class="line">CACHE_THREE_MINUTE = <span class="number">60</span> * <span class="number">3</span></span><br><span class="line">CACHE_FIVE_MINUTE = <span class="number">60</span> * <span class="number">5</span></span><br><span class="line">CACHE_TEN_MINUTE = <span class="number">60</span> * <span class="number">10</span></span><br><span class="line">CACHE_HALF_HOUR = <span class="number">60</span> * <span class="number">30</span></span><br><span class="line">CACHE_HOUR = <span class="number">60</span> * <span class="number">60</span></span><br><span class="line">CACHE_THREE_HOUR = <span class="number">60</span> * <span class="number">60</span> * <span class="number">3</span></span><br><span class="line">CACHE_TWELVE_HOUR = <span class="number">60</span> * <span class="number">60</span> * <span class="number">12</span></span><br><span class="line">CACHE_DAY = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span></span><br><span class="line">CACHE_WEEK = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">7</span></span><br><span class="line">CACHE_MONTH = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">TEST_USER_INFO = <span class="string">&#x27;zer0py2c:user_token:&#123;0&#125;&#x27;</span></span><br><span class="line">TEST_EXECUTE_SET = <span class="string">&#x27;zer0py2c:test_execute_set:case:&#123;&#125;&#x27;</span></span><br><span class="line">TEST_EXECUTE_STATS = <span class="string">&#x27;zer0py2c:test_execute_set:stats:&#123;&#125;&#x27;</span></span><br><span class="line">TEST_EXECUTE_TASK = <span class="string">&#x27;zer0py2c:test_execute_set:task:&#123;&#125;&#x27;</span></span><br><span class="line">TEST_EXECUTE_PARAMETER = <span class="string">&#x27;zer0py2c:test_execute_set:extract_parameter:&#123;&#125;&#x27;</span></span><br><span class="line">DATA_STRUCTURE_CASE_UPDATE = <span class="string">&#x27;zer0py2c:data_structure:user:&#123;&#125;&#x27;</span></span><br><span class="line">TEST_USER_LOGIN_TIME = <span class="string">&#x27;zer0py2c:user_login_time:&#123;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">PREFORMANCE_RUN_STATUS = <span class="string">&#x27;performance_test:status&#x27;</span></span><br><span class="line">PREFORMANCE_FREE = <span class="number">0</span></span><br><span class="line">PREFORMANCE_INIT = <span class="number">10</span></span><br><span class="line">PREFORMANCE_BUSY = <span class="number">20</span></span><br><span class="line">PREFORMANCE_ABORT = <span class="number">30</span></span><br><span class="line"></span><br><span class="line">PREFORMANCE_CODE = <span class="string">&#x27;code&#x27;</span></span><br><span class="line">PREFORMANCE_SIGN_CODE = <span class="string">&#x27;sign_code&#x27;</span></span><br><span class="line"></span><br><span class="line">THREAD_MAXMUM = <span class="number">100</span></span><br><span class="line">RUN_NUMBER_MAXMUM = <span class="number">1000000</span></span><br><span class="line">DEBUG_MAXMUM = <span class="number">100</span></span><br></pre></td></tr></table></figure>



<ul>
<li>加密与解密</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Cryptodome <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">from</span> Cryptodome.Cipher <span class="keyword">import</span> PKCS1_v1_5</span><br><span class="line"><span class="keyword">from</span> Cryptodome.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"></span><br><span class="line">PUBLIC_KEY = <span class="string">&quot;&quot;&quot;-----BEGIN PUBLIC KEY-----</span></span><br><span class="line"><span class="string">MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC2YZVJzRrn1kyJHZS+7O5/oteO</span></span><br><span class="line"><span class="string">YOkbiNk3ndRLQscgdDf3k+RaRomzvHro5w2h6T9A5rd45vM0kyKcBezE/Za1pOKq</span></span><br><span class="line"><span class="string">meovah1zxxoofQJ8k91ybVFXYJx99k9ravCMr+wKuCpuuwPe8he10iBZ465vVZ6g</span></span><br><span class="line"><span class="string">5Nbg4gM2PcV7OMVLaQIDAQAB</span></span><br><span class="line"><span class="string">-----END PUBLIC KEY-----&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">PRIVATE_KEY = <span class="string">&quot;&quot;&quot;-----BEGIN RSA PRIVATE KEY-----</span></span><br><span class="line"><span class="string">MIICXQIBAAKBgQC2YZVJzRrn1kyJHZS+7O5/oteOYOkbiNk3ndRLQscgdDf3k+Ra</span></span><br><span class="line"><span class="string">RomzvHro5w2h6T9A5rd45vM0kyKcBezE/Za1pOKqmeovah1zxxoofQJ8k91ybVFX</span></span><br><span class="line"><span class="string">YJx99k9ravCMr+wKuCpuuwPe8he10iBZ465vVZ6g5Nbg4gM2PcV7OMVLaQIDAQAB</span></span><br><span class="line"><span class="string">AoGABgNhutMngjyVcta4omgOhS3jLcjJ8sbrA4Y220w5DhvALc+7XBMejpWmAfMT</span></span><br><span class="line"><span class="string">8YekAWGsq7CwqjDON7Gge3kRdz7PDwjaPBwkOebD1aYNWDM0TfQiINVxCkZpPoKg</span></span><br><span class="line"><span class="string">KTpIELQUoD6KMWw8NUwcasqHcz1HCC6DnRYpG3XJXYhdJDECQQDCvQ/tkHOi92He</span></span><br><span class="line"><span class="string">RioTHSiJd/5TvgPgBH7dqsldT6mwS67EbrWFEiSSRbzref6wv+r8sXb9d436Ltno</span></span><br><span class="line"><span class="string">4lngQWZZAkEA78FX7EzS/TAV/PDfWh/ncozY9tFqfPNk4w96LVb5wy8oc9M419K9</span></span><br><span class="line"><span class="string">yLWeSfiBcXK2l+S2XYk49OhuznklZWiLkQJAL1c+1AXV1rxE8oAkIlloTWL6VOlQ</span></span><br><span class="line"><span class="string">j9kH7mNiaGjBW7ZKWj5/qkXq1hRWBPi3TciaG6wYvS2fOj7BgrfkGXxMoQJBAIbT</span></span><br><span class="line"><span class="string">zNUHEvPtMcBP2Nr+7BJgILcUZ3UjDw4dqxCKQ+S+xVn1Y5cDXVTcxcpFZM3eu85J</span></span><br><span class="line"><span class="string">gUCypYQcngug1yXjF/ECQQCBZZAZ+GhpzqwerwqyfNHvrahSrfp14l6STktaCjKy</span></span><br><span class="line"><span class="string">IR4n5TomCkHRaeXPgn1YVIhz5/LaVZJuKK3eiN2Wbdwy</span></span><br><span class="line"><span class="string">-----END RSA PRIVATE KEY-----&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypto_rsa_password</span>(<span class="params">password</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        public_key = RSA.import_key(PUBLIC_KEY)</span><br><span class="line">        cipher = PKCS1_v1_5.new(public_key)</span><br><span class="line">        text = cipher.encrypt(password.encode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> base64.b64encode(text)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypto_rsa_password</span>(<span class="params">password</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        private_key = RSA.import_key(PRIVATE_KEY)</span><br><span class="line">        cipher = PKCS1_v1_5.new(private_key)</span><br><span class="line">        text = cipher.decrypt(base64.b64decode(password), <span class="string">b&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> text.decode()</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> password</span><br></pre></td></tr></table></figure>



<ul>
<li>辅助工具</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> typing</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web.backend.app.core <span class="keyword">import</span> g</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.init.database <span class="keyword">import</span> init_redis_pool</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.init.exception <span class="keyword">import</span> AccessTokenFail</span><br><span class="line"><span class="keyword">from</span> web.backend.app.common.constant <span class="keyword">import</span> TEST_USER_INFO</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_str_uuid</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(uuid.uuid4()).replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">current_user</span>(<span class="params">token: <span class="built_in">str</span> = <span class="literal">None</span></span>) -&gt; typing.<span class="type">Union</span>[typing.<span class="type">Dict</span>[typing.Text, typing.<span class="type">Any</span>], <span class="literal">None</span>]:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> g.redis:</span><br><span class="line">        g.redis = <span class="keyword">await</span> init_redis_pool()</span><br><span class="line">    user = <span class="keyword">await</span> g.redis.get(TEST_USER_INFO.<span class="built_in">format</span>(g.token <span class="keyword">if</span> <span class="keyword">not</span> token <span class="keyword">else</span> token))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">raise</span> AccessTokenFail()</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MZipFile</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, zip_path</span>):</span><br><span class="line">        self.<span class="built_in">zip</span> = zipfile.ZipFile(zip_path, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_filecount</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.<span class="built_in">zip</span>.namelist())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_one_file</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> self.<span class="built_in">zip</span>.namelist():</span><br><span class="line">            <span class="keyword">yield</span> self.read_lines(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_lines</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">return</span> [line.decode() <span class="keyword">for</span> line <span class="keyword">in</span> self.<span class="built_in">zip</span>.<span class="built_in">open</span>(name).readlines()]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_filenames</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.<span class="built_in">zip</span>.namelist()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_to</span>(<span class="params">self, path</span>):</span><br><span class="line">        self.<span class="built_in">zip</span>.extractall(path)</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cal_hash_by_file</span>(<span class="params">path, algorithm</span>):</span><br><span class="line">        size = os.path.getsize(path)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">while</span> size &gt;= <span class="number">1024</span> * <span class="number">1024</span>:</span><br><span class="line">                algorithm.update(f.read(<span class="number">1024</span> * <span class="number">1024</span>))</span><br><span class="line">                size -= <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line">            algorithm.update(f.read())</span><br><span class="line">        <span class="keyword">return</span> algorithm.hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MD5Utils</span>:</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_file_by_zip</span>(<span class="params">zip_name, file_name, mode=<span class="string">&quot;w&quot;</span></span>):</span><br><span class="line">        <span class="built_in">zip</span> = MZipFile(zip_path=zip_name)</span><br><span class="line">        pattern = zip_name.split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">        pattern = <span class="string">f&quot;<span class="subst">&#123;pattern&#125;</span>/([0-9a-z]+)\n?&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_name, mode, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">            <span class="keyword">for</span> name <span class="keyword">in</span> <span class="built_in">zip</span>.get_filenames():</span><br><span class="line">                name = name.strip()</span><br><span class="line">                s = re.<span class="keyword">match</span>(pattern, name)</span><br><span class="line">                <span class="keyword">if</span> s:</span><br><span class="line">                    fp.write(s.group(<span class="number">1</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">list_file_by_zip</span>(<span class="params">zip_name, file_name, mode=<span class="string">&quot;w&quot;</span></span>):</span><br><span class="line">        <span class="built_in">zip</span> = MZipFile(zip_path=zip_name)</span><br><span class="line">        pattern = zip_name.split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">        pattern = <span class="string">f&quot;<span class="subst">&#123;pattern&#125;</span>/([0-9a-z]+)\n?&quot;</span></span><br><span class="line">        hash_list = []</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> <span class="built_in">zip</span>.get_filenames():</span><br><span class="line">            name = name.strip()</span><br><span class="line">            s = re.<span class="keyword">match</span>(pattern, name)</span><br><span class="line">            <span class="keyword">if</span> s:</span><br><span class="line">                hash_list.append(s.group(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> hash_list</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cal_file_hash</span>(<span class="params">file_name</span>):</span><br><span class="line">        md5, sha1, sha256 = MZipFile.cal_hash_by_file(file_name, hashlib.md5()), MZipFile.cal_hash_by_file(</span><br><span class="line">            file_name, hashlib.sha1()), MZipFile.cal_hash_by_file(file_name, hashlib.sha256())</span><br><span class="line">        <span class="keyword">return</span> md5, sha1, sha256</span><br></pre></td></tr></table></figure>



<h6 id="2-2核心模块"><a href="#2-2核心模块" class="headerlink" title="2.2核心模块"></a>2.2核心模块</h6><ul>
<li>业务状态码</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CodeEnum</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">code</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.value[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">msg</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.value[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    PARTNER_CODE_OK = (<span class="number">0</span>, <span class="string">&quot;SUCCESS&quot;</span>)</span><br><span class="line">    PARTNER_CODE_FAIL = (-<span class="number">1</span>, <span class="string">&quot;FAILED&quot;</span>)</span><br><span class="line"></span><br><span class="line">    WRONG_USER_NAME_OR_PASSWORD = (<span class="number">10001</span>, <span class="string">&quot;账号或者密码错误！&quot;</span>)</span><br><span class="line">    PARTNER_CODE_EMPLOYEE_FAIL = (<span class="number">10002</span>, <span class="string">&quot;账号错误！&quot;</span>)</span><br><span class="line">    WRONG_USER_NAME_OR_PASSWORD_LOCK = (<span class="number">10003</span>, <span class="string">&quot;密码输入错误超过次数，请5分钟后再登录！&quot;</span>)</span><br><span class="line">    USERNAME_OR_EMAIL_IS_REGISTER = (<span class="number">10004</span>, <span class="string">&quot;用户名已被注册&quot;</span>)</span><br><span class="line">    USER_ID_IS_NULL = (<span class="number">10005</span>, <span class="string">&quot;用户id不能为空&quot;</span>)</span><br><span class="line">    PASSWORD_TWICE_IS_NOT_AGREEMENT = (<span class="number">10006</span>, <span class="string">&quot;两次输入的密码不一致&quot;</span>)</span><br><span class="line">    NEW_PWD_NO_OLD_PWD_EQUAL = (<span class="number">10007</span>, <span class="string">&quot;新密码不能与旧密码相同&quot;</span>)</span><br><span class="line">    OLD_PASSWORD_ERROR = (<span class="number">10008</span>, <span class="string">&quot;旧密码错误&quot;</span>)</span><br><span class="line"></span><br><span class="line">    PARTNER_CODE_TOKEN_EXPIRED_FAIL = (<span class="number">11000</span>, <span class="string">&quot;用户信息已过期&quot;</span>)</span><br><span class="line"></span><br><span class="line">    PARTNER_CODE_PARAMS_FAIL = (<span class="number">12000</span>, <span class="string">&quot;必填参数不能为空&quot;</span>)</span><br><span class="line"></span><br><span class="line">    PROJECT_HAS_MODULE_ASSOCIATION = (<span class="number">13000</span>, <span class="string">&quot;项目有模块或用例关联，不能删除&quot;</span>)</span><br><span class="line">    PROJECT_NAME_EXIST = (<span class="number">13001</span>, <span class="string">&quot;项目名已存在&quot;</span>)</span><br><span class="line"></span><br><span class="line">    MODULE_HAS_CASE_ASSOCIATION = (<span class="number">14000</span>, <span class="string">&quot; 模块有用例关联, 请删除对于模块下的用例&quot;</span>)</span><br><span class="line">    MODULE_NAME_EXIST = (<span class="number">14001</span>, <span class="string">&quot;模块名已存在&quot;</span>)</span><br><span class="line"></span><br><span class="line">    CASE_NAME_EXIST = (<span class="number">15000</span>, <span class="string">&quot;用例名已存在，请重新命名&quot;</span>)</span><br><span class="line">    SUITE_NAME_EXIST = (<span class="number">15001</span>, <span class="string">&quot;套件名已存在，请重新命名&quot;</span>)</span><br><span class="line">    CASE_NOT_EXIST = (<span class="number">15002</span>, <span class="string">&quot;用例不存在&quot;</span>)</span><br><span class="line">    CASE_UPLOAD_FROM_POSTMAN = (<span class="number">15003</span>, <span class="string">&quot;导入失败&quot;</span>)</span><br><span class="line"></span><br><span class="line">    MENU_HAS_MODULE_ASSOCIATION = (<span class="number">16000</span>, <span class="string">&quot;当前菜单下管理的子菜单，不能删除！&quot;</span>)</span><br><span class="line">    MENU_NAME_EXIST = (<span class="number">16001</span>, <span class="string">&quot;菜单名称已存在&quot;</span>)</span><br><span class="line"></span><br><span class="line">    LOOKUP_CODE_NOT_EMPTY = (<span class="number">17000</span>, <span class="string">&quot;字典code不能为空!&quot;</span>)</span><br><span class="line">    LOOKUP_NOT_EXIST = (<span class="number">17001</span>, <span class="string">&quot;字典不存在!&quot;</span>)</span><br><span class="line">    LOOKUP_CODE_EXIST = (<span class="number">17002</span>, <span class="string">&quot;字典code已存在!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    TASK_NAME_EXIST = (<span class="number">18000</span>, <span class="string">&quot;定时任务名称以存在&quot;</span>)</span><br></pre></td></tr></table></figure>



<ul>
<li>自定义HTTP响应对象</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> typing</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> orjson</span><br><span class="line"><span class="keyword">from</span> starlette <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> starlette.responses <span class="keyword">import</span> Response, JSONResponse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web.backend.app.core <span class="keyword">import</span> g</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.codeenum <span class="keyword">import</span> CodeEnum</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.serialize <span class="keyword">import</span> default_serialize</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ORJSONResponse</span>(<span class="title class_ inherited__">JSONResponse</span>):</span><br><span class="line">    media_type = <span class="string">&quot;application/json&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">render</span>(<span class="params">self, content: typing.<span class="type">Any</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="keyword">return</span> orjson.dumps(</span><br><span class="line">            content,</span><br><span class="line">            option=orjson.OPT_NON_STR_KEYS | orjson.OPT_SERIALIZE_NUMPY | orjson.OPT_PASSTHROUGH_DATETIME,</span><br><span class="line">            default=default_serialize</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">partner_success</span>(<span class="params"></span></span><br><span class="line"><span class="params">        data=<span class="literal">None</span>, headers=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        code=CodeEnum.PARTNER_CODE_OK.code,</span></span><br><span class="line"><span class="params">        msg=CodeEnum.PARTNER_CODE_OK.msg,</span></span><br><span class="line"><span class="params">        http_code=status.HTTP_200_OK,</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        data = &#123;&#125;</span><br><span class="line">    success = <span class="literal">True</span> <span class="keyword">if</span> code == CodeEnum.PARTNER_CODE_OK.code <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line">    content = <span class="built_in">dict</span>(code=code, msg=msg, data=data, success=success, trace_id=g.trace_id)</span><br><span class="line">    <span class="keyword">return</span> ORJSONResponse(status_code=http_code, content=content, headers=headers <span class="keyword">or</span> &#123;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resp_200</span>(<span class="params">*, data: typing.<span class="type">Any</span> = <span class="string">&quot;&quot;</span>, msg: <span class="built_in">str</span> = <span class="string">&quot;HTTP_200_OK&quot;</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">200</span>, <span class="string">&quot;data&quot;</span>: data, <span class="string">&quot;msg&quot;</span>: msg&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resp_400</span>(<span class="params">*, data: <span class="built_in">str</span> = <span class="literal">None</span>, msg: <span class="built_in">str</span> = <span class="string">&quot;HTTP_400_BAD_REQUEST&quot;</span></span>) -&gt; Response:</span><br><span class="line">    <span class="keyword">return</span> ORJSONResponse(status_code=status.HTTP_400_BAD_REQUEST, content=&#123;<span class="string">&quot;code&quot;</span>: <span class="number">400</span>, <span class="string">&quot;data&quot;</span>: data, <span class="string">&quot;msg&quot;</span>: msg&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resp_401</span>(<span class="params">*, data: <span class="built_in">str</span> = <span class="literal">None</span>, msg: <span class="built_in">str</span> = <span class="string">&quot;HTTP_401_UNAUTHORIZED&quot;</span></span>) -&gt; Response:</span><br><span class="line">    <span class="keyword">return</span> ORJSONResponse(status_code=status.HTTP_401_UNAUTHORIZED, content=&#123;<span class="string">&quot;code&quot;</span>: <span class="number">401</span>, <span class="string">&quot;data&quot;</span>: data, <span class="string">&quot;msg&quot;</span>: msg&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resp_403</span>(<span class="params">*, data: <span class="built_in">str</span> = <span class="literal">None</span>, msg: <span class="built_in">str</span> = <span class="string">&quot;HTTP_403_FORBIDDEN&quot;</span></span>) -&gt; Response:</span><br><span class="line">    <span class="keyword">return</span> ORJSONResponse(status_code=status.HTTP_403_FORBIDDEN, content=&#123;<span class="string">&quot;code&quot;</span>: <span class="number">403</span>, <span class="string">&quot;data&quot;</span>: data, <span class="string">&quot;msg&quot;</span>: msg&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resp_404</span>(<span class="params">*, data: <span class="built_in">str</span> = <span class="literal">None</span>, msg: <span class="built_in">str</span> = <span class="string">&quot;HTTP_404_NOT_FOUND&quot;</span></span>) -&gt; Response:</span><br><span class="line">    <span class="keyword">return</span> ORJSONResponse(status_code=status.HTTP_404_NOT_FOUND, content=&#123;<span class="string">&quot;code&quot;</span>: <span class="number">404</span>, <span class="string">&quot;data&quot;</span>: data, <span class="string">&quot;msg&quot;</span>: msg&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resp_408</span>(<span class="params">*, data: <span class="built_in">str</span> = <span class="literal">None</span>, msg: <span class="built_in">str</span> = <span class="string">&quot;HTTP_408_REQUEST_TIMEOUT&quot;</span></span>) -&gt; Response:</span><br><span class="line">    <span class="keyword">return</span> ORJSONResponse(status_code=status.HTTP_408_REQUEST_TIMEOUT, content=&#123;<span class="string">&quot;code&quot;</span>: <span class="number">408</span>, <span class="string">&quot;data&quot;</span>: data, <span class="string">&quot;msg&quot;</span>: msg&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resp_429</span>(<span class="params">*, data: <span class="built_in">str</span> = <span class="literal">None</span>, msg: <span class="built_in">str</span> = <span class="string">&quot;HTTP_429_TOO_MANY_REQUESTS&quot;</span></span>) -&gt; Response:</span><br><span class="line">    <span class="keyword">return</span> ORJSONResponse(status_code=status.HTTP_429_TOO_MANY_REQUESTS,</span><br><span class="line">                          content=&#123;<span class="string">&quot;code&quot;</span>: <span class="number">429</span>, <span class="string">&quot;data&quot;</span>: data, <span class="string">&quot;msg&quot;</span>: msg&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resp_500</span>(<span class="params">*, data: <span class="built_in">str</span> = <span class="literal">None</span>, msg: typing.<span class="type">Union</span>[<span class="built_in">list</span>, <span class="built_in">dict</span>, <span class="built_in">str</span>] = <span class="string">&quot;HTTP_500_INTERNAL_SERVER_ERROR&quot;</span></span>) -&gt; Response:</span><br><span class="line">    <span class="keyword">return</span> ORJSONResponse(headers=&#123;<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>: <span class="string">&quot;*&quot;</span>&#125;,</span><br><span class="line">                          status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,</span><br><span class="line">                          content=&#123;<span class="string">&quot;code&quot;</span>: <span class="number">500</span>, <span class="string">&quot;data&quot;</span>: data, <span class="string">&quot;msg&quot;</span>: msg&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resp_501</span>(<span class="params">*, data: <span class="built_in">str</span> = <span class="literal">None</span>, msg: <span class="built_in">str</span> = <span class="string">&quot;HTTP_501_NOT_IMPLEMENTED&quot;</span></span>) -&gt; Response:</span><br><span class="line">    <span class="keyword">return</span> ORJSONResponse(status_code=status.HTTP_501_NOT_IMPLEMENTED, content=&#123;<span class="string">&quot;code&quot;</span>: <span class="number">501</span>, <span class="string">&quot;data&quot;</span>: data, <span class="string">&quot;msg&quot;</span>: msg&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resp_502</span>(<span class="params">*, data: <span class="built_in">str</span> = <span class="literal">None</span>, msg: <span class="built_in">str</span> = <span class="string">&quot;HTTP_502_BAD_GATEWAY&quot;</span></span>) -&gt; Response:</span><br><span class="line">    <span class="keyword">return</span> ORJSONResponse(status_code=status.HTTP_502_BAD_GATEWAY, content=&#123;<span class="string">&quot;code&quot;</span>: <span class="number">502</span>, <span class="string">&quot;data&quot;</span>: data, <span class="string">&quot;msg&quot;</span>: msg&#125;)</span><br></pre></td></tr></table></figure>



<ul>
<li>全局代理对象</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> typing</span><br><span class="line"><span class="keyword">from</span> contextvars <span class="keyword">import</span> ContextVar</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LocalProxy</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    __slots__ = (<span class="string">&quot;_storage&quot;</span>,)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self, <span class="string">&quot;_storage&quot;</span>, ContextVar(<span class="string">&quot;local_storage&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>) -&gt; typing.Iterator[typing.<span class="type">Tuple</span>[<span class="built_in">int</span>, typing.<span class="type">Any</span>]]:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">iter</span>(self._storage.get(&#123;&#125;).items())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__release_local__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self._storage.<span class="built_in">set</span>(&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name: <span class="built_in">str</span></span>) -&gt; typing.<span class="type">Any</span>:</span><br><span class="line">        values = self._storage.get(&#123;&#125;)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> values[name]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, name: <span class="built_in">str</span>, value: typing.<span class="type">Any</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        values = self._storage.get(&#123;&#125;).copy()</span><br><span class="line">        values[name] = value</span><br><span class="line">        self._storage.<span class="built_in">set</span>(values)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__delattr__</span>(<span class="params">self, name: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        values = self._storage.get(&#123;&#125;).copy()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">del</span> values[name]</span><br><span class="line">            self._storage.<span class="built_in">set</span>(values)</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">g = LocalProxy()</span><br></pre></td></tr></table></figure>



<ul>
<li>序列化工具</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> typing</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi.encoders <span class="keyword">import</span> jsonable_encoder</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Row</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> DeclarativeMeta</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unwrap_scalars</span>(<span class="params">items: typing.<span class="type">Union</span>[typing.<span class="type">Sequence</span>[Row], Row]</span>) \</span><br><span class="line">        -&gt; typing.<span class="type">Union</span>[typing.<span class="type">List</span>[typing.<span class="type">Dict</span>[typing.Text, typing.<span class="type">Any</span>]], typing.<span class="type">Dict</span>[<span class="built_in">str</span>, typing.<span class="type">Any</span>]]:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(items, typing.Iterable) <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(items, Row):</span><br><span class="line">        <span class="keyword">return</span> [default_serialize(item) <span class="keyword">for</span> item <span class="keyword">in</span> items]</span><br><span class="line">    <span class="keyword">return</span> default_serialize(items)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">default_serialize</span>(<span class="params">obj</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, datetime):</span><br><span class="line">            <span class="keyword">return</span> obj.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, Row):</span><br><span class="line">            data = <span class="built_in">dict</span>(<span class="built_in">zip</span>(obj._fields, obj._data))</span><br><span class="line">            <span class="keyword">return</span> &#123;key: default_serialize(value) <span class="keyword">for</span> key, value <span class="keyword">in</span> data.items()&#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(obj, <span class="string">&quot;__class__&quot;</span>) <span class="keyword">and</span> <span class="built_in">isinstance</span>(obj.__class__, DeclarativeMeta):</span><br><span class="line">            <span class="keyword">return</span> &#123;c.name: default_serialize(<span class="built_in">getattr</span>(obj, c.name)) <span class="keyword">for</span> c <span class="keyword">in</span> obj.__table__.columns&#125;</span><br><span class="line">    <span class="keyword">except</span> TypeError:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">repr</span>(obj)</span><br><span class="line">    <span class="keyword">return</span> jsonable_encoder(obj)</span><br></pre></td></tr></table></figure>



<h6 id="2-3初始化模块"><a href="#2-3初始化模块" class="headerlink" title="2.3初始化模块"></a>2.3初始化模块</h6><ul>
<li>允许跨域</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> starlette.middleware.cors <span class="keyword">import</span> CORSMiddleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web.backend.config <span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_cors</span>(<span class="params">app: FastAPI</span>):</span><br><span class="line">    app.add_middleware(</span><br><span class="line">        CORSMiddleware,</span><br><span class="line">        allow_origins=[<span class="built_in">str</span>(origin) <span class="keyword">for</span> origin <span class="keyword">in</span> config.CORS_ORIGINS],</span><br><span class="line">        allow_credentials=<span class="literal">True</span>,</span><br><span class="line">        allow_methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, <span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;DELETE&quot;</span>],</span><br><span class="line">        allow_headers=[<span class="string">&quot;*&quot;</span>],</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>



<ul>
<li>数据库连接</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> typing</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> aioredis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> asyncio <span class="keyword">import</span> current_task</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.exc <span class="keyword">import</span> IntegrityError</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.asyncio <span class="keyword">import</span> create_async_engine, \</span><br><span class="line">    AsyncSession, async_scoped_session, async_sessionmaker</span><br><span class="line"><span class="keyword">from</span> web.backend.config <span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SandboxRedis</span>(<span class="title class_ inherited__">Redis</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, name: <span class="built_in">str</span></span>) -&gt; typing.<span class="type">Any</span>:</span><br><span class="line">        data = <span class="keyword">await</span> <span class="built_in">super</span>(SandboxRedis, self).get(name)</span><br><span class="line">        <span class="keyword">return</span> json.loads(data) <span class="keyword">if</span> data <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params"></span></span><br><span class="line"><span class="params">            self,</span></span><br><span class="line"><span class="params">            name: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">            value: typing.<span class="type">Any</span>,</span></span><br><span class="line"><span class="params">            ex=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">            px=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">            nx: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">            xx: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">            keepttl: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    </span>) -&gt; typing.<span class="type">Any</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">super</span>(SandboxRedis, self).<span class="built_in">set</span>(name, json.dumps(value), ex=ex)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">init_redis_pool</span>() -&gt; SandboxRedis:</span><br><span class="line">    redis = <span class="keyword">await</span> SandboxRedis.from_url(</span><br><span class="line">        url=config.REDIS_URI,</span><br><span class="line">        encoding=config.GLOBAL_ENCODING,</span><br><span class="line">        decode_responses=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db_engine = create_async_engine(</span><br><span class="line">    url=config.DATABASE_URI,</span><br><span class="line">    echo=config.DATABASE_ECHO,</span><br><span class="line">    pool_pre_ping=<span class="literal">True</span>,</span><br><span class="line">    pool_recycle=<span class="number">60</span> * <span class="number">60</span> * <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">async_session_factory = async_sessionmaker(</span><br><span class="line">    bind=db_engine,</span><br><span class="line">    class_=AsyncSession,</span><br><span class="line">    autoflush=<span class="literal">False</span>,</span><br><span class="line">    autocommit=<span class="literal">False</span>,</span><br><span class="line">    expire_on_commit=<span class="literal">False</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">async_session = async_scoped_session(async_session_factory, scopefunc=current_task)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">database_session</span>(<span class="params">func: typing.<span class="type">Callable</span></span>):</span><br><span class="line"><span class="meta">    @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        arg_session = <span class="string">&quot;session&quot;</span></span><br><span class="line">        func_params = func.__code__.co_varnames</span><br><span class="line">        session_in_args = arg_session <span class="keyword">in</span> func_params <span class="keyword">and</span> func_params.index(arg_session) &lt; <span class="built_in">len</span>(args)</span><br><span class="line">        session_in_kwargs = arg_session <span class="keyword">in</span> kwargs</span><br><span class="line">        <span class="keyword">if</span> session_in_kwargs <span class="keyword">or</span> session_in_args:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> func(*args, **kwargs)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> async_session() <span class="keyword">as</span> session:</span><br><span class="line">                fs = functools.partial(func, session=session, *args, **kwargs)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">await</span> fs()</span><br><span class="line">                <span class="keyword">except</span> IntegrityError:</span><br><span class="line">                    <span class="keyword">await</span> session.rollback()</span><br><span class="line">                    <span class="keyword">raise</span></span><br><span class="line">                <span class="keyword">finally</span>:</span><br><span class="line">                    <span class="keyword">await</span> session.commit()</span><br><span class="line">                    <span class="keyword">await</span> async_session.remove()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure>



<ul>
<li>自定义异常类</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> typing</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.codeenum <span class="keyword">import</span> CodeEnum</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.httpresp <span class="keyword">import</span> resp_400, resp_404, partner_success</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">APIBaseException</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, err_or_code: typing.<span class="type">Union</span>[CodeEnum, <span class="built_in">str</span>]</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(err_or_code, CodeEnum):</span><br><span class="line">            code = err_or_code.code</span><br><span class="line">            msg = err_or_code.msg</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            code = CodeEnum.PARTNER_CODE_FAIL.code</span><br><span class="line">            msg = err_or_code</span><br><span class="line">        self.code = code</span><br><span class="line">        self.msg = msg</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;self.code&#125;</span>:<span class="subst">&#123;self.msg&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;self.code&#125;</span>:<span class="subst">&#123;self.msg&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IpError</span>(<span class="title class_ inherited__">APIBaseException</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(IpError, self).__init__(<span class="string">&quot;ip error&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserNotExist</span>(<span class="title class_ inherited__">APIBaseException</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(UserNotExist, self).__init__(<span class="string">&quot;user not exist&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AccessTokenFail</span>(<span class="title class_ inherited__">APIBaseException</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(AccessTokenFail, self).__init__(CodeEnum.PARTNER_CODE_TOKEN_EXPIRED_FAIL)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ParameterError</span>(<span class="title class_ inherited__">APIBaseException</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, err_code: typing.<span class="type">Union</span>[CodeEnum, <span class="built_in">str</span>]</span>):</span><br><span class="line">        <span class="built_in">super</span>(ParameterError, self).__init__(err_code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_exception</span>(<span class="params">app: FastAPI</span>):</span><br><span class="line"><span class="meta">    @app.exception_handler(<span class="params">IpError</span>)</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">ip_error_handler</span>(<span class="params">request: Request, exc: IpError</span>):</span><br><span class="line">        logger.warning(<span class="string">f&quot;<span class="subst">&#123;exc.msg&#125;</span>:<span class="subst">&#123;exc.code&#125;</span>\nURL:<span class="subst">&#123;request.method&#125;</span>-<span class="subst">&#123;request.url&#125;</span>\nHeaders:<span class="subst">&#123;request.headers&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> resp_400(msg=exc.msg)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.exception_handler(<span class="params">UserNotExist</span>)</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">user_not_exist_handler</span>(<span class="params">request: Request, exc: UserNotExist</span>):</span><br><span class="line">        logger.warning(<span class="string">f&quot;<span class="subst">&#123;exc.msg&#125;</span>:<span class="subst">&#123;exc.code&#125;</span>\nURL:<span class="subst">&#123;request.method&#125;</span>-<span class="subst">&#123;request.url&#125;</span>\nHeaders:<span class="subst">&#123;request.headers&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> resp_404(msg=exc.msg)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.exception_handler(<span class="params">ParameterError</span>)</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">all_exception_handler</span>(<span class="params">request: Request, exc: ParameterError</span>):</span><br><span class="line">        logger.error(<span class="string">f&quot;Params Error\n<span class="subst">&#123;request.method&#125;</span>URL:<span class="subst">&#123;request.url&#125;</span>\n&quot;</span></span><br><span class="line">                     <span class="string">f&quot;Headers:<span class="subst">&#123;request.headers&#125;</span>\n<span class="subst">&#123;traceback.format_exc()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> partner_success(code=exc.code, msg=exc.msg)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.exception_handler(<span class="params">Exception</span>)</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">all_exception_handler</span>(<span class="params">request: Request, exc: Exception</span>):</span><br><span class="line">        logger.error(<span class="string">f&quot;Global Error\n<span class="subst">&#123;request.method&#125;</span> URL:<span class="subst">&#123;request.url&#125;</span>\n&quot;</span></span><br><span class="line">                     <span class="string">f&quot;Headers:<span class="subst">&#123;request.headers&#125;</span>\n<span class="subst">&#123;traceback.format_exc()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> partner_success(code=CodeEnum.PARTNER_CODE_FAIL.code, msg=<span class="built_in">str</span>(exc),</span><br><span class="line">                               headers=&#123;<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>: <span class="string">&quot;*&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>



<ul>
<li>全局请求对象</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Request</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core <span class="keyword">import</span> g</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">init_global_request</span>(<span class="params">request: Request</span>):</span><br><span class="line">    g.request = request</span><br></pre></td></tr></table></figure>



<ul>
<li>日志</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> web.backend.config <span class="keyword">import</span> config</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core <span class="keyword">import</span> g</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logger_file</span>() -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_dir</span>(<span class="params">filename: <span class="built_in">str</span></span>) -&gt; Path:</span><br><span class="line">        path = Path(filename).absolute().parent / filename</span><br><span class="line">        <span class="keyword">not</span> Path(path).exists() <span class="keyword">and</span> Path.mkdir(path)</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line">    log_path = create_dir(config.LOGGER_DIR)</span><br><span class="line">    files = os.listdir(log_path)</span><br><span class="line">    <span class="built_in">len</span>(files) &gt; <span class="number">3</span> <span class="keyword">and</span> os.remove(os.path.join(log_path, files[<span class="number">0</span>]))</span><br><span class="line">    <span class="keyword">return</span> os.path.join(log_path, config.LOGGER_NAME)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">correlation_id_filter</span>(<span class="params">record</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_str_uuid</span>():</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(uuid.uuid4()).replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> g.trace_id:</span><br><span class="line">        g.trace_id = get_str_uuid()</span><br><span class="line">    record[<span class="string">&quot;trace_id&quot;</span>] = g.trace_id</span><br><span class="line">    <span class="keyword">return</span> record</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fmt = <span class="string">&quot;&lt;green&gt;&#123;time:YYYY-MM-DD HH:mm:ss.SSS&#125;&lt;/green&gt;| &#123;thread&#125; &quot;</span> \</span><br><span class="line">      <span class="string">&quot;| &lt;level&gt;&#123;level: &lt;8&#125;&lt;/level&gt; | &lt;yellow&gt; &#123;trace_id&#125; &lt;/yellow&gt; &quot;</span> \</span><br><span class="line">      <span class="string">&quot;| &lt;cyan&gt;&#123;name&#125;&lt;/cyan&gt;:&lt;cyan&gt;&#123;function&#125;&lt;/cyan&gt;:&lt;cyan&gt;&#123;line&#125;&lt;/cyan&gt; &quot;</span> \</span><br><span class="line">      <span class="string">&quot;| &lt;level&gt;&#123;message&#125;&lt;/level&gt;&quot;</span></span><br><span class="line">logger.remove()</span><br><span class="line">logger.add(</span><br><span class="line">    sys.stdout, level=config.LOGGER_LEVEL, colorize=<span class="literal">True</span>,</span><br><span class="line">    <span class="built_in">filter</span>=correlation_id_filter, <span class="built_in">format</span>=fmt</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InterceptHandler</span>(logging.Handler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">emit</span>(<span class="params">self, record</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            level = logger.level(record.levelname).name</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            level = record.levelno</span><br><span class="line">        logger_opt = logger.opt(depth=<span class="number">6</span>, exception=record.exc_info)</span><br><span class="line">        logger_opt.log(level, record.getMessage())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_logger</span>():</span><br><span class="line">    logger_name_list = [name <span class="keyword">for</span> name <span class="keyword">in</span> logging.root.manager.loggerDict]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> logger_name <span class="keyword">in</span> logger_name_list:</span><br><span class="line">        effective_level = logging.getLogger(logger_name).getEffectiveLevel()</span><br><span class="line">        <span class="keyword">if</span> effective_level &lt; logging.getLevelName(config.LOGGER_LEVEL.upper()):</span><br><span class="line">            logging.getLogger(logger_name).setLevel(config.LOGGER_LEVEL.upper())</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;.&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> logger_name:</span><br><span class="line">            logging.getLogger(logger_name).handlers = []</span><br><span class="line">            logging.getLogger(logger_name).addHandler(InterceptHandler())</span><br></pre></td></tr></table></figure>



<ul>
<li>中间件</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web.backend.config <span class="keyword">import</span> config</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core <span class="keyword">import</span> g</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.httpresp <span class="keyword">import</span> partner_success</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.init.exception <span class="keyword">import</span> AccessTokenFail</span><br><span class="line"><span class="keyword">from</span> web.backend.app.common.utils <span class="keyword">import</span> get_str_uuid</span><br><span class="line"><span class="keyword">from</span> web.backend.app.common.constant <span class="keyword">import</span> TEST_USER_INFO, CACHE_DAY</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login_verification</span>(<span class="params">request: Request</span>):</span><br><span class="line">    token = request.headers.get(<span class="string">&quot;token&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    router: <span class="built_in">str</span> = request.scope.get(<span class="string">&#x27;path&#x27;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> router.startswith(<span class="string">&quot;/sandbox/api/v1&quot;</span>) <span class="keyword">and</span> <span class="keyword">not</span> router.startswith(</span><br><span class="line">            <span class="string">&quot;/sandbox/api/v1/file&quot;</span>) <span class="keyword">and</span> router <span class="keyword">not</span> <span class="keyword">in</span> config.WHITE_ROUTER:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">            <span class="keyword">raise</span> AccessTokenFail()</span><br><span class="line">        user_info = <span class="keyword">await</span> g.redis.get(TEST_USER_INFO.<span class="built_in">format</span>(token))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_info:</span><br><span class="line">            <span class="keyword">raise</span> AccessTokenFail()</span><br><span class="line">        <span class="comment"># reset token time</span></span><br><span class="line">        <span class="keyword">await</span> g.redis.<span class="built_in">set</span>(TEST_USER_INFO.<span class="built_in">format</span>(token), user_info, CACHE_DAY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_middleware</span>(<span class="params">app: FastAPI</span>):</span><br><span class="line"><span class="meta">    @app.middleware(<span class="params"><span class="string">&quot;http&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">intercept</span>(<span class="params">request: Request, call_next</span>):</span><br><span class="line">        g.trace_id = get_str_uuid()</span><br><span class="line">        token = request.headers.get(<span class="string">&quot;token&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        g.redis, g.token = app.state.redis, token</span><br><span class="line">        remote_addr = request.headers.get(<span class="string">&quot;X-Real-IP&quot;</span>, request.client.host)</span><br><span class="line">        logger.info(<span class="string">f&quot;access_record-&gt;IP:<span class="subst">&#123;remote_addr&#125;</span>,method:<span class="subst">&#123;request.method&#125;</span>,url:<span class="subst">&#123;request.url&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">await</span> login_verification(request)</span><br><span class="line">        <span class="keyword">except</span> AccessTokenFail <span class="keyword">as</span> err:</span><br><span class="line">            <span class="keyword">return</span> partner_success(code=err.code, msg=err.msg)</span><br><span class="line">        response = <span class="keyword">await</span> call_next(request)</span><br><span class="line">        response.headers[<span class="string">&quot;X-request-id&quot;</span>] = g.trace_id</span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>



<ul>
<li>路由</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web.backend.config <span class="keyword">import</span> config</span><br><span class="line"><span class="keyword">from</span> web.backend.app.apiv1.router <span class="keyword">import</span> api_router</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_router</span>(<span class="params">app: FastAPI</span>):</span><br><span class="line">    app.include_router(api_router, prefix=config.API_PREFIX)</span><br></pre></td></tr></table></figure>



<h6 id="2-4Model类模块"><a href="#2-4Model类模块" class="headerlink" title="2.4Model类模块"></a>2.4Model类模块</h6><ul>
<li>BaseModel</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> typing</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, DateTime, Integer, func, select, \</span><br><span class="line">    update, delete, insert, Select, Executable, Result, ClauseList, String, Boolean</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.asyncio <span class="keyword">import</span> AsyncSession</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> as_declarative</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core <span class="keyword">import</span> g</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.init.database <span class="keyword">import</span> database_session</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.init.exception <span class="keyword">import</span> AccessTokenFail</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.serialize <span class="keyword">import</span> unwrap_scalars</span><br><span class="line"><span class="keyword">from</span> web.backend.app.common.utils <span class="keyword">import</span> current_user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@as_declarative()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseModel</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    __tablename__: <span class="built_in">str</span></span><br><span class="line">    __table_args__ = &#123;<span class="string">&quot;mysql_charset&quot;</span>: <span class="string">&quot;utf8&quot;</span>&#125;</span><br><span class="line">    __mapper_args__ = &#123;<span class="string">&quot;eager_defaults&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer(), nullable=<span class="literal">False</span>, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    created_on = Column(DateTime(), default=func.now(), comment=<span class="string">&quot;createTime&quot;</span>)</span><br><span class="line">    updated_on = Column(DateTime(), default=func.now(), onupdate=func.now(), nullable=<span class="literal">False</span>, comment=<span class="string">&quot;updateTime&quot;</span>)</span><br><span class="line">    created_by = Column(Integer, nullable=<span class="literal">True</span>, comment=<span class="string">&quot;creator_id&quot;</span>)</span><br><span class="line">    updated_by = Column(Integer, nullable=<span class="literal">True</span>, comment=<span class="string">&quot;updater_id&quot;</span>)</span><br><span class="line">    trace_id = Column(String(<span class="number">255</span>), nullable=<span class="literal">False</span>, comment=<span class="string">&quot;trace_id&quot;</span>)</span><br><span class="line">    enabled_flag = Column(Boolean(), default=<span class="number">1</span>, nullable=<span class="literal">False</span>, comment=<span class="string">&quot;is_deleted&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">cls, _<span class="built_in">id</span>: typing.<span class="type">Union</span>[<span class="built_in">int</span>, <span class="built_in">str</span>], to_dict=<span class="literal">False</span></span>) -&gt; typing.<span class="type">Union</span>[<span class="string">&quot;BaseModel&quot;</span>, typing.<span class="type">Dict</span>]:</span><br><span class="line">        sql = select(cls).where(cls.<span class="built_in">id</span> == _<span class="built_in">id</span>)</span><br><span class="line">        result = <span class="keyword">await</span> cls.execute(sql)</span><br><span class="line">        data = result.scalar()</span><br><span class="line">        <span class="keyword">return</span> data <span class="keyword">if</span> <span class="keyword">not</span> to_dict <span class="keyword">else</span> unwrap_scalars(data)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">cls, params: typing.<span class="type">Dict</span>, to_dict: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; typing.<span class="type">Union</span>[<span class="string">&quot;BaseModel&quot;</span>, typing.<span class="type">Dict</span>]:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(params, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;insert params error&quot;</span>)</span><br><span class="line">        params = &#123;key: value <span class="keyword">for</span> key, value <span class="keyword">in</span> params.items() <span class="keyword">if</span> <span class="built_in">hasattr</span>(cls, key)&#125;</span><br><span class="line">        params = <span class="keyword">await</span> cls.handle_params(params)</span><br><span class="line">        stmt = insert(cls).values(**params)</span><br><span class="line">        result = <span class="keyword">await</span> cls.execute(stmt)</span><br><span class="line">        (primary_key,) = result.inserted_primary_key</span><br><span class="line">        params[<span class="string">&quot;id&quot;</span>] = primary_key</span><br><span class="line">        <span class="keyword">return</span> cls(**params) <span class="keyword">if</span> <span class="keyword">not</span> to_dict <span class="keyword">else</span> params</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">upsert</span>(<span class="params">cls, params: typing.<span class="type">Union</span>[typing.<span class="type">Dict</span>]</span>) -&gt; typing.<span class="type">Dict</span>[typing.Text, typing.<span class="type">Any</span>]:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(params, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;upsert params error&quot;</span>)</span><br><span class="line">        params = &#123;key: value <span class="keyword">for</span> key, value <span class="keyword">in</span> params.items() <span class="keyword">if</span> <span class="built_in">hasattr</span>(cls, key)&#125;</span><br><span class="line">        params = <span class="keyword">await</span> cls.handle_params(params)</span><br><span class="line">        _<span class="built_in">id</span> = params.get(<span class="string">&quot;id&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> _<span class="built_in">id</span>:</span><br><span class="line">            stmt = update(cls).where(cls.<span class="built_in">id</span> == _<span class="built_in">id</span>).values(**params)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            stmt = insert(cls).values(**params)</span><br><span class="line">        result = <span class="keyword">await</span> cls.execute(stmt)</span><br><span class="line">        <span class="keyword">if</span> result.is_insert:</span><br><span class="line">            (primary_key,) = result.inserted_primary_key</span><br><span class="line">            params[<span class="string">&quot;id&quot;</span>] = primary_key</span><br><span class="line">        <span class="keyword">return</span> params</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">cls, _<span class="built_in">id</span>: typing.<span class="type">Union</span>[<span class="built_in">int</span>, <span class="built_in">str</span>], _hard: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">if</span> _hard <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">            stmt = update(cls).where(cls.<span class="built_in">id</span> == _<span class="built_in">id</span>).values(enabled_flag=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            stmt = delete(cls).where(cls.<span class="built_in">id</span> == _<span class="built_in">id</span>)</span><br><span class="line">        result = <span class="keyword">await</span> cls.execute(stmt)</span><br><span class="line">        <span class="keyword">return</span> result.rowcount</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_all</span>(<span class="params">cls</span>) -&gt; typing.<span class="type">Optional</span>[typing.<span class="type">Any</span>]:</span><br><span class="line">        stmt = select(cls.get_columns())</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> cls.get_result(stmt)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line"><span class="meta">    @database_session</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">cls, stmt: Executable, params: typing.<span class="type">Any</span> = <span class="literal">None</span>, session: AsyncSession = <span class="literal">None</span></span>) \</span><br><span class="line">            -&gt; Result[typing.<span class="type">Any</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> session.execute(stmt, params)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_columns</span>(<span class="params">cls, exclude: <span class="built_in">set</span> = <span class="literal">None</span></span>) -&gt; ClauseList:</span><br><span class="line">        exclude = exclude <span class="keyword">if</span> exclude <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> ClauseList(*[i <span class="keyword">for</span> i <span class="keyword">in</span> cls.__table__.columns <span class="keyword">if</span> i.name <span class="keyword">not</span> <span class="keyword">in</span> exclude])</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_result</span>(<span class="params">cls, stmt: Select, first=<span class="literal">False</span></span>) -&gt; typing.<span class="type">Any</span>:</span><br><span class="line">        result = <span class="keyword">await</span> cls.execute(stmt)</span><br><span class="line">        data = result.first() <span class="keyword">if</span> first <span class="keyword">else</span> result.fetchall()</span><br><span class="line">        <span class="keyword">return</span> unwrap_scalars(data) <span class="keyword">if</span> data <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_params</span>(<span class="params">cls, params: typing.<span class="type">Any</span></span>) -&gt; typing.<span class="type">Any</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(params, <span class="built_in">dict</span>):</span><br><span class="line">            params = &#123;key: value <span class="keyword">for</span> key, value <span class="keyword">in</span> params.items() <span class="keyword">if</span> <span class="built_in">hasattr</span>(cls, key)&#125;</span><br><span class="line">            updated_by = params.get(<span class="string">&quot;updated_by&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">            created_by = params.get(<span class="string">&quot;created_by&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">            params[<span class="string">&quot;trace_id&quot;</span>] = g.trace_id</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                user = <span class="keyword">await</span> current_user()</span><br><span class="line">            <span class="keyword">except</span> AccessTokenFail:</span><br><span class="line">                user = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">if</span> user:</span><br><span class="line">                user_id = user.get(<span class="string">&quot;id&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">                params[<span class="string">&quot;updated_by&quot;</span>] = user_id</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> params.get(<span class="string">&quot;id&quot;</span>, <span class="literal">None</span>):</span><br><span class="line">                    params[<span class="string">&quot;created_by&quot;</span>] = user_id</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> updated_by:</span><br><span class="line">                    params[<span class="string">&quot;updated_by&quot;</span>] = <span class="number">0</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> created_by:</span><br><span class="line">                    params[<span class="string">&quot;created_by&quot;</span>] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(params, <span class="built_in">list</span>):</span><br><span class="line">            params = [<span class="keyword">await</span> cls.handle_params(p) <span class="keyword">for</span> p <span class="keyword">in</span> params]</span><br><span class="line">        <span class="keyword">return</span> params</span><br></pre></td></tr></table></figure>



<ul>
<li>UserModel</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, String, Text, Integer, JSON</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> select</span><br><span class="line"><span class="keyword">from</span> web.backend.app.model.base <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    __tablename__ = <span class="string">&quot;t_user&quot;</span></span><br><span class="line">    username = Column(String(<span class="number">64</span>), nullable=<span class="literal">False</span>, comment=<span class="string">&quot;username&quot;</span>, index=<span class="literal">True</span>)</span><br><span class="line">    password = Column(Text, nullable=<span class="literal">False</span>, comment=<span class="string">&quot;password&quot;</span>)</span><br><span class="line">    email = Column(String(<span class="number">64</span>), nullable=<span class="literal">True</span>, comment=<span class="string">&quot;email&quot;</span>)</span><br><span class="line">    permission = Column(Integer, nullable=<span class="literal">False</span>, comment=<span class="string">&quot;permission&quot;</span>)</span><br><span class="line">    status = Column(Integer, nullable=<span class="literal">False</span>, comment=<span class="string">&quot;user status&quot;</span>, default=<span class="number">0</span>)</span><br><span class="line">    remarks = Column(String(<span class="number">255</span>), nullable=<span class="literal">True</span>, comment=<span class="string">&quot;desc for user&quot;</span>)</span><br><span class="line">    avatar = Column(Text, nullable=<span class="literal">True</span>, comment=<span class="string">&quot;icon&quot;</span>)</span><br><span class="line">    tags = Column(JSON, nullable=<span class="literal">True</span>, comment=<span class="string">&quot;tags&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user_by_name</span>(<span class="params">cls, username: <span class="built_in">str</span></span>):</span><br><span class="line">        stmt = select(*cls.get_columns()).where(cls.username == username)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> cls.get_result(stmt, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">list</span>(<span class="params">cls</span>):</span><br><span class="line">        stmt = select(*cls.get_columns()).order_by(cls.<span class="built_in">id</span>.desc())</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> cls.get_result(stmt)</span><br></pre></td></tr></table></figure>



<h6 id="2-5Schema类模块"><a href="#2-5Schema类模块" class="headerlink" title="2.5Schema类模块"></a>2.5Schema类模块</h6><ul>
<li>UserSchema</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> typing</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"><span class="keyword">from</span> web.backend.app.common.encrypto <span class="keyword">import</span> decrypto_rsa_password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserLogin</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span> = Field(..., description=<span class="string">&quot;username&quot;</span>)</span><br><span class="line">    password: <span class="built_in">str</span> = Field(..., description=<span class="string">&quot;password&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserQuery</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span> = Field(<span class="literal">None</span>, description=<span class="string">&quot;username&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserCreate</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span> = Field(<span class="literal">None</span>, title=<span class="string">&quot;id&quot;</span>, description=<span class="string">&quot;id&quot;</span>)</span><br><span class="line">    username: <span class="built_in">str</span> = Field(..., title=<span class="string">&quot;username&quot;</span>, description=<span class="string">&quot;username&quot;</span>)</span><br><span class="line">    password: <span class="built_in">str</span> = Field(description=<span class="string">&quot;password&quot;</span>, default=decrypto_rsa_password(<span class="string">&quot;zer0py2c&quot;</span>))</span><br><span class="line">    email: <span class="built_in">str</span> = Field(<span class="literal">None</span>, description=<span class="string">&quot;email&quot;</span>)</span><br><span class="line">    permission: <span class="built_in">int</span> = Field(<span class="literal">None</span>, description=<span class="string">&quot;permission&quot;</span>)</span><br><span class="line">    remarks: <span class="built_in">str</span> = Field(<span class="literal">None</span>, description=<span class="string">&quot;remarks&quot;</span>)</span><br><span class="line">    avatar: <span class="built_in">str</span> = Field(<span class="literal">None</span>, description=<span class="string">&quot;avatar&quot;</span>)</span><br><span class="line">    tags: typing.<span class="type">List</span> = Field(<span class="literal">None</span>, description=<span class="string">&quot;tags&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserResetPassword</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span> = Field(..., description=<span class="string">&quot;id&quot;</span>)</span><br><span class="line">    old_pwd: <span class="built_in">str</span> = Field(..., description=<span class="string">&quot;old_pwd&quot;</span>)</span><br><span class="line">    new_pwd: <span class="built_in">str</span> = Field(..., description=<span class="string">&quot;new_pwd&quot;</span>)</span><br><span class="line">    re_new_pwd: <span class="built_in">str</span> = Field(..., description=<span class="string">&quot;re_new_pwd&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserDelete</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span> = Field(..., title=<span class="string">&quot;id&quot;</span>, description=<span class="string">&quot;id&quot;</span>)</span><br></pre></td></tr></table></figure>



<h6 id="2-6服务模块"><a href="#2-6服务模块" class="headerlink" title="2.6服务模块"></a>2.6服务模块</h6><ul>
<li>UserService</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> typing</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core <span class="keyword">import</span> g</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.codeenum <span class="keyword">import</span> CodeEnum</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.serialize <span class="keyword">import</span> default_serialize</span><br><span class="line"><span class="keyword">from</span> web.backend.app.model.user <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> web.backend.app.schema.user <span class="keyword">import</span> UserLogin, UserCreate, \</span><br><span class="line">    UserResetPassword, UserDelete</span><br><span class="line"><span class="keyword">from</span> web.backend.app.common.constant <span class="keyword">import</span> TEST_USER_INFO, CACHE_DAY</span><br><span class="line"><span class="keyword">from</span> web.backend.app.common.encrypto <span class="keyword">import</span> decrypto_rsa_password, \</span><br><span class="line">    encrypto_rsa_password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">params: UserLogin</span>) -&gt; typing.<span class="type">Dict</span>[typing.Text, typing.<span class="type">Any</span>]:</span><br><span class="line">        username = params.username</span><br><span class="line">        password = params.password</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">and</span> <span class="keyword">not</span> password:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(CodeEnum.PARTNER_CODE_PARAMS_FAIL.msg)</span><br><span class="line">        user = <span class="keyword">await</span> User.get_user_by_name(username)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(CodeEnum.WRONG_USER_NAME_OR_PASSWORD.msg)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> decrypto_rsa_password(user[<span class="string">&quot;password&quot;</span>]) != password:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(CodeEnum.WRONG_USER_NAME_OR_PASSWORD.msg)</span><br><span class="line">        token = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        login_time = default_serialize(datetime.now())</span><br><span class="line">        tags = user.get(<span class="string">&quot;tags&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        permission = user.get(<span class="string">&quot;permission&quot;</span>)</span><br><span class="line">        token_user = &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: user[<span class="string">&quot;id&quot;</span>], <span class="string">&quot;token&quot;</span>: token,</span><br><span class="line">            <span class="string">&quot;login_time&quot;</span>: login_time, <span class="string">&quot;username&quot;</span>: username,</span><br><span class="line">            <span class="string">&quot;permission&quot;</span>: <span class="string">&quot;super&quot;</span> <span class="keyword">if</span> permission &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="string">&quot;normal&quot;</span>,</span><br><span class="line">            <span class="string">&quot;tags&quot;</span>: tags <span class="keyword">if</span> tags <span class="keyword">else</span> []</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">await</span> g.redis.<span class="built_in">set</span>(TEST_USER_INFO.<span class="built_in">format</span>(token), token_user, CACHE_DAY)</span><br><span class="line">        ip = g.request.headers.get(<span class="string">&quot;X-Real-IP&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ip:</span><br><span class="line">            ip = g.request.client.host</span><br><span class="line">        logger.info(<span class="string">&quot;Login success! username: &#123;&#125;, ip: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(username, ip))</span><br><span class="line">        <span class="keyword">return</span> token_user</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">        token = g.request.headers.get(<span class="string">&quot;token&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">await</span> g.redis.delete(TEST_USER_INFO.<span class="built_in">format</span>(token))</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            logger.error(traceback.format_exc())</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">params: UserCreate</span>) -&gt; <span class="string">&quot;User&quot;</span>:</span><br><span class="line">        user = <span class="keyword">await</span> User.get_user_by_name(params.username)</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(CodeEnum.USERNAME_OR_EMAIL_IS_REGISTER.msg)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> User.create(params.<span class="built_in">dict</span>())</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">params: UserDelete</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> User.delete(params.<span class="built_in">id</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            logger.error(traceback.format_exc())</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">token: <span class="built_in">str</span></span>) -&gt; typing.<span class="type">Dict</span>[typing.Text, typing.<span class="type">Any</span>]:</span><br><span class="line">        user = <span class="keyword">await</span> g.redis.get(TEST_USER_INFO.<span class="built_in">format</span>(token))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(CodeEnum.PARTNER_CODE_TOKEN_EXPIRED_FAIL.msg)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: user.get(<span class="string">&quot;id&quot;</span>, <span class="literal">None</span>),</span><br><span class="line">            <span class="string">&quot;username&quot;</span>: user.get(<span class="string">&quot;username&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">reset_password</span>(<span class="params">params: UserResetPassword</span>):</span><br><span class="line">        <span class="keyword">if</span> params.new_pwd != params.re_new_pwd:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(CodeEnum.PASSWORD_TWICE_IS_NOT_AGREEMENT.msg)</span><br><span class="line">        user_info = <span class="keyword">await</span> User.get(params.<span class="built_in">id</span>)</span><br><span class="line">        pwd = decrypto_rsa_password(user_info.password)</span><br><span class="line">        <span class="keyword">if</span> params.old_pwd != pwd:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(CodeEnum.OLD_PASSWORD_ERROR.msg)</span><br><span class="line">        <span class="keyword">if</span> params.new_pwd == pwd:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(CodeEnum.NEW_PWD_NO_OLD_PWD_EQUAL.msg)</span><br><span class="line">        new_pwd = encrypto_rsa_password(params.new_pwd)</span><br><span class="line">        <span class="keyword">await</span> User.update(**&#123;<span class="string">&quot;password&quot;</span>: new_pwd, <span class="string">&quot;id&quot;</span>: params.<span class="built_in">id</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user_by_token</span>(<span class="params">token: <span class="built_in">str</span></span>) -&gt; \</span><br><span class="line">            typing.<span class="type">Union</span>[typing.<span class="type">Dict</span>[typing.Text, typing.<span class="type">Any</span>], <span class="literal">None</span>]:</span><br><span class="line">        token_user = <span class="keyword">await</span> g.redis.get(TEST_USER_INFO.<span class="built_in">format</span>(token))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token_user:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(CodeEnum.PARTNER_CODE_TOKEN_EXPIRED_FAIL.msg)</span><br><span class="line">        user_info = <span class="keyword">await</span> User.get(token_user.get(<span class="string">&quot;id&quot;</span>))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_info:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(CodeEnum.PARTNER_CODE_TOKEN_EXPIRED_FAIL.msg)</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: user_info.<span class="built_in">id</span>, <span class="string">&quot;avatar&quot;</span>: user_info.avatar,</span><br><span class="line">            <span class="string">&quot;username&quot;</span>: user_info.username, <span class="string">&quot;nickname&quot;</span>: user_info.nickname,</span><br><span class="line">            <span class="string">&quot;permission&quot;</span>: user_info.permission, <span class="string">&quot;tags&quot;</span>: user_info.tags,</span><br><span class="line">            <span class="string">&quot;login_time&quot;</span>: token_user.get(<span class="string">&quot;login_time&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_all_user</span>():</span><br><span class="line">        _<span class="built_in">all</span> = <span class="keyword">await</span> User.<span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">return</span> _<span class="built_in">all</span></span><br></pre></td></tr></table></figure>



<h6 id="2-7API接口模块"><a href="#2-7API接口模块" class="headerlink" title="2.7API接口模块"></a>2.7API接口模块</h6><ul>
<li>UserAPI</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter, Request</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.httpresp <span class="keyword">import</span> partner_success</span><br><span class="line"><span class="keyword">from</span> web.backend.app.schema.user <span class="keyword">import</span> UserLogin, UserCreate, UserDelete</span><br><span class="line"><span class="keyword">from</span> web.backend.app.service.user <span class="keyword">import</span> UserService</span><br><span class="line"></span><br><span class="line">router = APIRouter()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/login&quot;</span>, description=<span class="string">&quot;login&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">params: UserLogin</span>):</span><br><span class="line">    data = <span class="keyword">await</span> UserService.login(params)</span><br><span class="line">    <span class="keyword">return</span> partner_success(data, msg=<span class="string">&quot;Login Success!&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/logout&quot;</span>, description=<span class="string">&quot;logout&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    <span class="keyword">await</span> UserService.logout()</span><br><span class="line">    <span class="keyword">return</span> partner_success()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/get_user_by_token&quot;</span>, description=<span class="string">&quot;get_user_by_token&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user_by_token</span>(<span class="params">request: Request</span>):</span><br><span class="line">    token = request.headers.get(<span class="string">&quot;token&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    user = <span class="keyword">await</span> UserService.get_user_by_token(token)</span><br><span class="line">    <span class="keyword">return</span> partner_success(user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/list&quot;</span>, description=<span class="string">&quot;list&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user_by_name</span>():</span><br><span class="line">    data = <span class="keyword">await</span> UserService.get_all_user()</span><br><span class="line">    <span class="keyword">return</span> partner_success(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/register&quot;</span>, description=<span class="string">&quot;register&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">user_register</span>(<span class="params">user: UserCreate</span>):</span><br><span class="line">    data = <span class="keyword">await</span> UserService.register(user)</span><br><span class="line">    <span class="keyword">return</span> partner_success(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/delete&quot;</span>, description=<span class="string">&quot;delete&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">params: UserDelete</span>):</span><br><span class="line">    data = <span class="keyword">await</span> UserService.delete(params)</span><br><span class="line">    <span class="keyword">return</span> partner_success(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/verify&quot;</span>, description=<span class="string">&quot;verify&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">request: Request</span>):</span><br><span class="line">    token = request.headers.get(<span class="string">&quot;token&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    user = <span class="keyword">await</span> UserService.verify(token)</span><br><span class="line">    <span class="keyword">return</span> partner_success(user)</span><br></pre></td></tr></table></figure>



<ul>
<li>路由</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"><span class="keyword">from</span> web.backend.app.apiv1.endpoint <span class="keyword">import</span> user, file</span><br><span class="line"></span><br><span class="line">api_router = APIRouter()</span><br><span class="line"></span><br><span class="line">api_router.include_router(user.router, prefix=<span class="string">&quot;/user&quot;</span>, tags=[<span class="string">&quot;user&quot;</span>])</span><br></pre></td></tr></table></figure>



<h6 id="2-8初始化数据库"><a href="#2-8初始化数据库" class="headerlink" title="2.8初始化数据库"></a>2.8初始化数据库</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web.backend.app.core.init.database <span class="keyword">import</span> db_engine</span><br><span class="line"><span class="keyword">from</span> web.backend.app.model.base <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">init_db</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> db_engine.begin() <span class="keyword">as</span> conn:</span><br><span class="line">        <span class="keyword">await</span> conn.run_sync(BaseModel.metadata.drop_all)</span><br><span class="line">        <span class="keyword">await</span> conn.run_sync(BaseModel.metadata.create_all)</span><br></pre></td></tr></table></figure>



<h6 id="2-9主程序"><a href="#2-9主程序" class="headerlink" title="2.9主程序"></a>2.9主程序</h6><ul>
<li>ENV变量</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">REDIS_URI</span>=redis://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span>/<span class="number">0</span></span><br><span class="line"><span class="attr">SQLITE3_DATABASE_URI</span>=sqlite+aiosqlite:///./sql_app.db?check_same_thread=<span class="literal">False</span></span><br></pre></td></tr></table></figure>



<ul>
<li>系统配置</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> typing</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseSettings, AnyHttpUrl, Field</span><br><span class="line"></span><br><span class="line">project_desc = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    maintainer: zer0py2c</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span>(<span class="title class_ inherited__">BaseSettings</span>):</span><br><span class="line">    PROJECT_DESC: <span class="built_in">str</span> = project_desc</span><br><span class="line">    PROJECT_VERSION: typing.<span class="type">Union</span>[<span class="built_in">int</span>, <span class="built_in">str</span>] = <span class="number">1.0</span></span><br><span class="line">    BASE_URL: AnyHttpUrl = <span class="string">&quot;http://127.0.0.1:9999&quot;</span></span><br><span class="line">    API_PREFIX: <span class="built_in">str</span> = <span class="string">&quot;/sandbox/api/v1&quot;</span></span><br><span class="line">    STATIC_DIR: <span class="built_in">str</span> = <span class="string">&quot;static&quot;</span></span><br><span class="line">    GLOBAL_ENCODING: <span class="built_in">str</span> = <span class="string">&quot;utf8&quot;</span></span><br><span class="line">    CORS_ORIGINS: typing.<span class="type">List</span>[typing.<span class="type">Any</span>] = [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">    WHITE_ROUTER = [<span class="string">&quot;/sandbox/api/v1/user/login&quot;</span>]</span><br><span class="line">    SECRET_KEY: <span class="built_in">str</span> = <span class="string">&quot;kPBDjVk0o3Y1wLxdODxBpjwEjo7-Euegg4kdnzFIRjc&quot;</span></span><br><span class="line">    ACCESS_TOKEN_EXPIRE_MINUTES: <span class="built_in">int</span> = <span class="number">60</span> * <span class="number">24</span> * <span class="number">1</span></span><br><span class="line">    REDIS_URI: <span class="built_in">str</span> = Field(..., env=<span class="string">&quot;REDIS_URI&quot;</span>)</span><br><span class="line">    DATABASE_URI: <span class="built_in">str</span> = Field(..., env=<span class="string">&quot;SQLITE3_DATABASE_URI&quot;</span>)  <span class="comment"># SQLite3 async</span></span><br><span class="line">    <span class="comment"># DATABASE_URI: str = &quot;mysql+asyncmy://root:123456@localhost:3306/zer0py2c?charset=UTF8MB4&quot;  # MySQL async</span></span><br><span class="line">    <span class="comment"># DATABASE_URI: str = &quot;postgresql+asyncpg://postgres:123456@localhost:5432/postgres&quot;  # PostgreSQL async</span></span><br><span class="line">    DATABASE_ECHO: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line">    LOGGER_DIR: <span class="built_in">str</span> = <span class="string">&quot;logs&quot;</span></span><br><span class="line">    LOGGER_NAME: <span class="built_in">str</span> = <span class="string">&quot;web_api.log&quot;</span></span><br><span class="line">    LOGGER_LEVEL: <span class="built_in">str</span> = <span class="string">&quot;INFO&quot;</span></span><br><span class="line">    LOGGER_ROTATION: <span class="built_in">str</span> = <span class="string">&quot;10MB&quot;</span></span><br><span class="line">    LOGGER_RETENTION: <span class="built_in">str</span> = <span class="string">&quot;7days&quot;</span></span><br><span class="line">    BASEDIR: <span class="built_in">str</span> = os.path.join(os.path.abspath(os.path.dirname(os.path.dirname(__file__))))</span><br><span class="line">    TEST_FILES_DIR: <span class="built_in">str</span> = os.path.join(os.path.abspath(os.path.dirname(os.path.dirname(__file__))), <span class="string">&quot;files&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Config</span>:</span><br><span class="line">        case_sensitive = <span class="literal">True</span></span><br><span class="line">        env_file = <span class="string">&quot;.env&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">config = Config()</span><br></pre></td></tr></table></figure>



<ul>
<li>主模块</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends</span><br><span class="line"><span class="keyword">from</span> web.backend.config <span class="keyword">import</span> config</span><br><span class="line"><span class="keyword">from</span> web.backend.app.core.init <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># from web.backend.app.model import init_db</span></span><br><span class="line"></span><br><span class="line">app = FastAPI(</span><br><span class="line">    title=<span class="string">&quot;fastapi_project_demo&quot;</span>,</span><br><span class="line">    description=config.PROJECT_DESC,</span><br><span class="line">    version=config.PROJECT_VERSION,</span><br><span class="line">    dependencies=[Depends(init_global_request)]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_app</span>():</span><br><span class="line">    init_logger()</span><br><span class="line">    init_exception(app)</span><br><span class="line">    init_router(app)</span><br><span class="line">    init_middleware(app)</span><br><span class="line">    init_cors(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.on_event(<span class="params"><span class="string">&quot;startup&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">startup</span>():</span><br><span class="line">    init_app()</span><br><span class="line">    <span class="comment"># await init_db()</span></span><br><span class="line">    app.state.redis = <span class="keyword">await</span> init_redis_pool()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.on_event(<span class="params"><span class="string">&quot;shutdown&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">shutdown</span>():</span><br><span class="line">    <span class="keyword">await</span> app.state.redis.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">&quot;main:app&quot;</span>, host=<span class="string">&quot;127.0.0.1&quot;</span>, port=<span class="number">9999</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-08-21</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://example.com/2023/08/21/FastAPI工程化项目案例/,zer0py2c个人博客,FastAPI工程化项目案例,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2023/08/04/%E5%A4%9A%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B/" title="多进程调度器的使用案例">Post siguiente</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>